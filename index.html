<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Sistema de Reconhecimento Facial Avan√ßado</title>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #27ae60;
      --danger: #e74c3c;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f6fa;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 30px;
    }

    .split {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 30px;
    }

    .panel {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #eee;
    }

    .video-container {
      position: relative;
      width: 100%;
      height: 400px;
      border-radius: 10px;
      overflow: hidden;
      background: #000;
    }

    #videoFeed {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #btnStart { background: var(--secondary); color: white; }
    #btnCapture { background: var(--success); color: white; }
    #btnStop { background: var(--danger); color: white; }
    #btnDelete { background: #e67e22; color: white; }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }

    #status {
      padding: 12px;
      margin: 15px 0;
      border-radius: 6px;
      background: #ecf0f1;
      font-weight: 500;
    }

    #userList {
      width: 100%;
      height: 150px;
      margin: 10px 0;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 6px;
    }

    .progress-container {
      width: 100%;
      height: 20px;
      background: #eee;
      border-radius: 10px;
      margin: 15px 0;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: var(--success);
      transition: width 0.3s ease;
    }

    .face-overlay {
      position: absolute;
      border: 3px solid #00ff00;
      box-shadow: 0 0 15px #00ff0040;
      pointer-events: none;
    }

    .pose-instruction {
      color: var(--primary);
      font-weight: 600;
      text-align: center;
      margin: 15px 0;
      padding: 10px;
      background: #fff3cd;
      border-radius: 6px;
    }

    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: var(--danger);
      color: white;
      border-radius: 8px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ Sistema de Reconhecimento Facial Avan√ßado ü§ñ</h1>
    <div class="split">
      <div class="panel">
        <h2>üìã INSTRU√á√ïES</h2>
        <ol>
          <li>Clique em ‚ÄúLigar C√¢mera‚Äù</li>
          <li>Digite seu nome completo</li>
          <li>Siga as instru√ß√µes de pose (olhar para lados, cima, baixo)</li>
          <li>Clique em ‚ÄúCapturar Rosto (20x)‚Äù</li>
          <li>Aguarde at√© o status confirmar</li>
          <li>Veja seu nome na lista</li>
          <li>Selecione e clique em ‚ÄúExcluir‚Äù para remover</li>
        </ol>
      </div>
      <div class="panel">
        <div class="video-container">
          <video id="videoFeed" autoplay playsinline></video>
        </div>
        <div class="progress-container">
          <div class="progress-bar" style="width: 0%"></div>
        </div>
        <div class="pose-instruction" id="poseText"></div>
        <div class="controls">
          <button id="btnStart">üé• Ligar C√¢mera</button>
          <button id="btnCapture" disabled>üì∏ Capturar Rosto (20x)</button>
          <button id="btnStop" disabled>‚èπÔ∏è Desligar C√¢mera</button>
        </div>
        <input type="text" id="userName" placeholder="Digite seu nome completo"/>
        <div id="status">üî¥ Status: Aguardando inicializa√ß√£o</div>
        <div id="results"></div>
        <div class="manage">
          <select id="userList" multiple></select>
          <button id="btnDelete">üóëÔ∏è Excluir Cadastro</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as vision from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.mjs';

    class FacialRecognitionSystem {
      constructor() {
        this.video = document.getElementById('videoFeed');
        this.faceDetector = null;
        this.cameraStream = null;
        this.isCapturing = false;
        this.captureCount = 0;
        this.currentPose = 0;
        this.poses = ['center', 'left', 'right', 'up', 'down'];
        this.faceDB = JSON.parse(localStorage.getItem('faceDB') || '{"users":[]}');
        this.initializeElements();
        this.initializeEventListeners();
      }

      initializeElements() {
        this.elements = {
          btnStart: document.getElementById('btnStart'),
          btnCapture: document.getElementById('btnCapture'),
          btnStop: document.getElementById('btnStop'),
          btnDelete: document.getElementById('btnDelete'),
          userName: document.getElementById('userName'),
          status: document.getElementById('status'),
          results: document.getElementById('results'),
          userList: document.getElementById('userList'),
          progressBar: document.querySelector('.progress-bar'),
          poseText: document.getElementById('poseText')
        };
      }

      initializeEventListeners() {
        this.elements.btnStart.addEventListener('click', () => this.startCamera());
        this.elements.btnCapture.addEventListener('click', () => this.startCapture());
        this.elements.btnStop.addEventListener('click', () => this.stopCamera());
        this.elements.btnDelete.addEventListener('click', () => this.deleteUser());
      }

      async initializeFaceDetector() {
        try {
          const fileset = await vision.FilesetResolver.forVisionTasks(
            'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm'
          );
          
          this.faceDetector = await vision.FaceDetector.createFromOptions(fileset, {
            baseOptions: {
              modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/face_detector/blaze_face_short_range/float16/latest/blaze_face_short_range.tflite',
              delegate: 'GPU',
            },
            runningMode: 'VIDEO',
            minDetectionConfidence: 0.85,
          });
          
          this.updateStatus('üü¢ Sistema pronto');
        } catch (error) {
          this.handleError(`Erro na inicializa√ß√£o: ${error.message}`);
        }
      }

      async startCamera() {
        try {
          this.cameraStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: 'user',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            } 
          });
          
          this.video.srcObject = this.cameraStream;
          await this.initializeFaceDetector();
          this.detectionLoop();
          this.updateControls(true);
          this.updateStatus('üü¢ C√¢mera ativa');
        } catch (error) {
          this.handleError(`Erro na c√¢mera: ${error.message}`);
        }
      }

      async detectionLoop() {
        if (!this.faceDetector) return;
        
        const detect = async () => {
          if (this.video.readyState < 2) return;
          
          const detections = await this.faceDetector.detectForVideo(
            this.video, 
            performance.now()
          );

          if (detections.detections.length > 0) {
            this.processDetection(detections.detections[0]);
          }
          
          requestAnimationFrame(detect);
        };
        
        detect();
      }

      processDetection(detection) {
        this.drawFaceOverlay(detection);
        const embedding = detection.keypoints.flatMap(p => [p.x, p.y]);
        
        if (this.isCapturing) {
          this.handleCapture(embedding);
        } else {
          this.handleRecognition(embedding);
        }
      }

      drawFaceOverlay(detection) {
        const canvas = document.createElement('canvas');
        const rect = detection.boundingBox;
        canvas.className = 'face-overlay';
        canvas.style.width = `${rect.width}px`;
        canvas.style.height = `${rect.height}px`;
        canvas.style.left = `${rect.originX}px`;
        canvas.style.top = `${rect.originY}px`;
        
        const container = document.querySelector('.video-container');
        container.querySelectorAll('.face-overlay').forEach(el => el.remove());
        container.appendChild(canvas);
      }

      startCapture() {
        if (!this.validateName()) return;
        
        this.isCapturing = true;
        this.captureCount = 0;
        this.currentPose = 0;
        this.updateProgress(0);
        this.updatePoseInstruction();
        this.elements.btnCapture.disabled = true;
        this.updateStatus('‚è≥ Capturando poses...');
      }

      handleCapture(embedding) {
        if (this.captureCount >= 20) return this.stopCapture();
        
        if (performance.now() - this.lastCapture > 250) {
          this.captureCount++;
          this.lastCapture = performance.now();
          this.saveEmbedding(embedding);
          this.updateProgress((this.captureCount / 20) * 100);
          
          if (this.captureCount % 4 === 0) {
            this.currentPose++;
            this.updatePoseInstruction();
          }
        }
      }

      saveEmbedding(embedding) {
        const user = this.faceDB.users.find(u => u.name === this.elements.userName.value.trim()) || 
          { name: this.elements.userName.value.trim(), embeddings: [] };
        
        if (!user.embeddings) user.embeddings = [];
        user.embeddings.push(embedding);
        
        if (!this.faceDB.users.some(u => u.name === user.name)) {
          this.faceDB.users.push(user);
        }
        
        localStorage.setItem('faceDB', JSON.stringify(this.faceDB));
      }

      handleRecognition(embedding) {
        const matches = this.faceDB.users.flatMap(user => 
          user.embeddings.map(emb => ({
            name: user.name,
            similarity: this.calculateSimilarity(emb, embedding)
          }))
        );
        
        const bestMatch = matches.sort((a, b) => b.similarity - a.similarity)[0];
        
        if (bestMatch && bestMatch.similarity > 0.85) {
          this.elements.results.textContent = `üëã Bem-vindo, ${bestMatch.name}! (${Math.round(bestMatch.similarity * 100)}%)`;
        } else {
          this.elements.results.textContent = '';
        }
      }

      calculateSimilarity(a, b) {
        const dotProduct = a.reduce((sum, val, i) => sum + val * b[i], 0);
        const magnitudeA = Math.sqrt(a.reduce((sum, val) => sum + val ** 2, 0));
        const magnitudeB = Math.sqrt(b.reduce((sum, val) => sum + val ** 2, 0));
        return dotProduct / (magnitudeA * magnitudeB);
      }

      stopCapture() {
        this.isCapturing = false;
        this.elements.btnCapture.disabled = false;
        this.updateStatus(`‚úÖ ${this.elements.userName.value.trim()} cadastrado com sucesso!`);
        this.elements.userName.value = '';
        this.updateUserList();
      }

      updateControls(cameraActive) {
        this.elements.btnStart.disabled = cameraActive;
        this.elements.btnStop.disabled = !cameraActive;
        this.elements.btnCapture.disabled = !cameraActive;
      }

      updateStatus(message) {
        this.elements.status.textContent = message;
      }

      updateProgress(percentage) {
        this.elements.progressBar.style.width = `${percentage}%`;
      }

      updatePoseInstruction() {
        const instructions = [
          'Olhe diretamente para a c√¢mera',
          'Vire a cabe√ßa para a esquerda',
          'Vire a cabe√ßa para a direita',
          'Olhe para cima',
          'Olhe para baixo'
        ];
        this.elements.poseText.textContent = instructions[this.currentPose % 5];
      }

      validateName() {
        const name = this.elements.userName.value.trim();
        if (!name) {
          this.showAlert('Por favor, digite seu nome completo!');
          return false;
        }
        if (this.faceDB.users.some(u => u.name === name)) {
          this.showAlert('Este nome j√° est√° cadastrado!');
          return false;
        }
        return true;
      }

      showAlert(message) {
        const alert = document.createElement('div');
        alert.className = 'alert';
        alert.textContent = message;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
      }

      updateUserList() {
        this.elements.userList.innerHTML = '';
        this.faceDB.users.forEach(user => {
          const option = document.createElement('option');
          option.value = user.name;
          option.textContent = `${user.name} (${user.embeddings.length} amostras)`;
          this.elements.userList.appendChild(option);
        });
      }

      deleteUser() {
        const selected = this.elements.userList.value;
        if (!selected) return this.showAlert('Selecione um usu√°rio para excluir!');
        
        if (confirm(`Tem certeza que deseja excluir ${selected}?`)) {
          this.faceDB.users = this.faceDB.users.filter(u => u.name !== selected);
          localStorage.setItem('faceDB', JSON.stringify(this.faceDB));
          this.updateUserList();
          this.updateStatus(`üóëÔ∏è ${selected} removido com sucesso`);
        }
      }

      stopCamera() {
        if (this.cameraStream) {
          this.cameraStream.getTracks().forEach(track => track.stop());
          this.video.srcObject = null;
        }
        this.updateControls(false);
        this.updateStatus('‚èπÔ∏è C√¢mera desativada');
        document.querySelectorAll('.face-overlay').forEach(el => el.remove());
      }

      handleError(message) {
        this.updateStatus(`üî¥ Erro: ${message}`);
        console.error(message);
      }
    }

    const faceSystem = new FacialRecognitionSystem();
    faceSystem.updateUserList();
  </script>
</body>
</html>
