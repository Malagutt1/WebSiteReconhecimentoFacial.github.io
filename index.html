<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <link rel="stylesheet" href="styles.css">
  <title>Sistema de Reconhecimento Facial</title>
</head>
<body>
  <div class="container">
    <h1>ğŸ¤– Sistema de Reconhecimento Facial ğŸ¤–</h1>
    <div class="split">
      <div class="panel">
        <h2>ğŸ“‹ INSTRUÃ‡Ã•ES</h2>
        <ol>
          <li>Clique em â€œLigar CÃ¢meraâ€</li>
          <li>Digite seu nome completo</li>
          <li>Siga as instruÃ§Ãµes de pose (olhar para lados, cima, baixo)</li>
          <li>Clique em â€œCapturar Rosto (20x)â€</li>
          <li>Aguarde atÃ© o status confirmar</li>
          <li>Veja seu nome na lista</li>
          <li>Selecione e clique em â€œExcluirâ€ para remover</li>
        </ol>
      </div>
      <div class="panel">
        <div class="video-container"><video id="videoFeed" autoplay playsinline></video></div>
        <div class="controls">
          <button id="btnStart">ğŸ¥ Ligar CÃ¢mera</button>
          <button id="btnCapture" disabled>ğŸ“¸ Capturar Rosto (20x)</button>
          <button id="btnStop" disabled>â¹ï¸ Desligar CÃ¢mera</button>
        </div>
        <input type="text" id="userName" placeholder="Digite seu nome completo"/>
        <div id="status">ğŸ”´ Status: Aguardando inicializaÃ§Ã£o</div>
        <div id="results"></div>
        <div class="manage">
          <select id="userList" multiple></select>
          <button id="btnDelete">ğŸ—‘ï¸ Excluir Cadastro</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as vision from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.mjs';

    const video = document.getElementById('videoFeed');
    const btnStart = document.getElementById('btnStart');
    const btnCapture = document.getElementById('btnCapture');
    const btnStop = document.getElementById('btnStop');
    const userName = document.getElementById('userName');
    const status = document.getElementById('status');
    const results = document.getElementById('results');
    const userList = document.getElementById('userList');
    const btnDelete = document.getElementById('btnDelete');

    let faceDetector, cameraStream;
    let isCapturing = false, captureCount = 0;
    const TOTAL = 20, DELAY = 250;
    let lastCapture = 0;
    let loopInterval;

    let faceDB = JSON.parse(localStorage.getItem('faceDB') || '{"users":[]}');

    function cosineSimilarity(a, b) {
      const dot = a.reduce((sum, val, i) => sum + val * b[i], 0);
      const magA = Math.sqrt(a.reduce((sum, val) => sum + val * val, 0));
      const magB = Math.sqrt(b.reduce((sum, val) => sum + val * val, 0));
      return dot / (magA * magB);
    }

    function recognize(emb) {
      const sims = [];
      faceDB.users.forEach((u) => {
        u.embeddings.forEach((e) => {
          sims.push({ name: u.name, sim: cosineSimilarity(e, emb) });
        });
      });

      sims.sort((a, b) => b.sim - a.sim);

      const best = sims[0];
      const second = sims[1] || { sim: 0 };

      const threshold = 0.88;
      const margin = 0.03;

      if (best.sim > threshold && best.sim - second.sim > margin) {
        results.textContent = `ğŸ‘‹ Bem-vindo, ${best.name}! (${Math.round(best.sim * 100)}%)`;
      } else {
        results.textContent = '';
      }
    }

    function saveEmbedding(emb) {
      const name = userName.value.trim();
      let user = faceDB.users.find((u) => u.name === name);
      if (!user) {
        user = { name, embeddings: [] };
        faceDB.users.push(user);
      }
      user.embeddings.push(emb);
      localStorage.setItem('faceDB', JSON.stringify(faceDB));
    }

    async function init() {
      try {
        const fileset = await vision.FilesetResolver.forVisionTasks(
          'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm'
        );
        faceDetector = await vision.FaceDetector.createFromOptions(fileset, {
          baseOptions: {
            modelAssetPath:
              'https://storage.googleapis.com/mediapipe-models/face_detector/blaze_face_short_range/float16/latest/blaze_face_short_range.tflite',
            delegate: 'GPU',
          },
          runningMode: 'VIDEO',
          minDetectionConfidence: 0.85,
        });
        status.textContent = 'ğŸŸ¢ Sistema pronto';
      } catch (e) {
        status.textContent = 'ğŸ”´ Erro IA: ' + e.message;
      }
    }

    async function frameLoop() {
      if (!faceDetector || !cameraStream) return;
      const now = performance.now();
      const res = await faceDetector.detectForVideo(video, now);
      if (res.detections.length) {
        const emb = res.detections[0].keypoints.flatMap((p) => [p.x, p.y]);
        if (isCapturing && now - lastCapture > DELAY) {
          lastCapture = now;
          captureCount++;
          status.textContent = `ğŸ“¸ Captura ${captureCount}/${TOTAL} â€” Vire o rosto para lados e cima/baixo`;
          saveEmbedding(emb);
          if (captureCount >= TOTAL) stopCapture();
        }
        if (!isCapturing) recognize(emb);
      }
    }

    function startCapture() {
      if (!userName.value.trim()) return alert('Digite um nome!');
      isCapturing = true;
      captureCount = 0;
      lastCapture = 0;
      btnCapture.disabled = true;
      status.textContent = 'â³ Preparando captura...';
      setTimeout(() => {
        status.textContent = 'ğŸ“¸ Capturando fotos...';
      }, 500);
    }

    function stopCapture() {
      isCapturing = false;
      btnCapture.disabled = false;
      status.textContent = `âœ… ${userName.value.trim()} cadastrado com sucesso!`;
      userName.value = '';
      updateList();
    }

    function updateList() {
      userList.innerHTML = '';
      faceDB.users.forEach((u) => {
        const o = document.createElement('option');
        o.value = u.name;
        o.textContent = `${u.name} (${u.embeddings.length} fotos)`;
        userList.append(o);
      });
    }

    btnStart.onclick = async () => {
      cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      video.srcObject = cameraStream;
      await init();
      loopInterval = setInterval(frameLoop, 100);
      btnStart.disabled = true;
      btnStop.disabled = false;
      btnCapture.disabled = false;
      status.textContent = 'ğŸŸ¢ CÃ¢mera ativa';
    };

    btnCapture.onclick = startCapture;

    btnStop.onclick = () => {
      cameraStream.getTracks().forEach((t) => t.stop());
      video.srcObject = null;
      clearInterval(loopInterval);
      btnStart.disabled = false;
      btnStop.disabled = true;
      btnCapture.disabled = true;
      status.textContent = 'â¹ï¸ CÃ¢mera parada';
      results.textContent = '';
    };

    btnDelete.onclick = () => {
      const sel = userList.value;
      faceDB.users = faceDB.users.filter((u) => u.name !== sel);
      localStorage.setItem('faceDB', JSON.stringify(faceDB));
      updateList();
      status.textContent = `ğŸ—‘ï¸ ${sel} removido`;
    };

    updateList();
  </script>
</body>
</html>
