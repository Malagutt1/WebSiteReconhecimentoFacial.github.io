<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Sistema de Reconhecimento Facial Avan√ßado</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
    }
    
    h1 {
      text-align: center;
      padding: 25px;
      background: rgba(0, 0, 0, 0.4);
      font-size: 2.2rem;
      letter-spacing: 1px;
      border-bottom: 2px solid #00b4d8;
    }
    
    .split {
      display: flex;
      flex-wrap: wrap;
      padding: 20px;
      gap: 25px;
    }
    
    .panel {
      flex: 1;
      min-width: 300px;
      background: rgba(30, 30, 50, 0.8);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
    }
    
    .panel h2 {
      color: #00b4d8;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #00b4d8;
      font-size: 1.8rem;
    }
    
    ol {
      padding-left: 25px;
      margin-bottom: 25px;
    }
    
    ol li {
      margin-bottom: 12px;
      line-height: 1.6;
    }
    
    .facial-science {
      background: rgba(0, 180, 216, 0.15);
      padding: 18px;
      border-radius: 12px;
      margin-top: auto;
    }
    
    .facial-science h3 {
      color: #90e0ef;
      margin-bottom: 12px;
    }
    
    .facial-science p {
      line-height: 1.7;
    }
    
    .video-container {
      position: relative;
      width: 100%;
      padding-top: 75%;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
      transform: scaleX(-1); /* Corrige o espelhamento */
    }
    
    #videoFeed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .canvas-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
    }
    
    #faceCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    button {
      flex: 1;
      min-width: 120px;
      padding: 14px;
      background: linear-gradient(to right, #0077b6, #00b4d8);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button:hover {
      background: linear-gradient(to right, #0067a6, #0096c7);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 180, 216, 0.4);
    }
    
    button:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.7;
    }
    
    #userName {
      width: 100%;
      padding: 14px;
      margin-bottom: 20px;
      border-radius: 8px;
      border: 2px solid #00b4d8;
      background: rgba(0, 0, 0, 0.4);
      color: white;
      font-size: 1rem;
    }
    
    #userName:focus {
      outline: none;
      border-color: #90e0ef;
      box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.3);
    }
    
    .progress-container {
      width: 100%;
      height: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, #4caf50, #8bc34a);
      border-radius: 10px;
      transition: width 0.3s ease;
    }
    
    #status {
      padding: 14px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
      text-align: center;
      background: rgba(0, 0, 0, 0.4);
      transition: all 0.3s ease;
    }
    
    .ready {
      background: rgba(76, 175, 80, 0.2);
      color: #a5d6a7;
    }
    
    .capturing {
      background: rgba(255, 193, 7, 0.2);
      color: #ffd54f;
    }
    
    .warning {
      background: rgba(244, 67, 54, 0.2);
      color: #ef9a9a;
    }
    
    #results {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.2rem;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.4);
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .manage {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: auto;
    }
    
    #userList {
      width: 100%;
      height: 150px;
      padding: 12px;
      border-radius: 8px;
      border: 2px solid #00b4d8;
      background: rgba(0, 0, 0, 0.4);
      color: white;
      font-size: 1rem;
    }
    
    #userList option {
      padding: 8px;
      border-bottom: 1px solid #444;
    }
    
    @media (max-width: 768px) {
      .split {
        flex-direction: column;
      }
      
      h1 {
        font-size: 1.8rem;
        padding: 15px;
      }
      
      .panel {
        padding: 20px;
      }
      
      .controls {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ Sistema de Reconhecimento Facial Avan√ßado ü§ñ</h1>
    <div class="split">
      <div class="panel">
        <h2>üìã INSTRU√á√ïES</h2>
        <ol>
          <li>Clique em "Ligar C√¢mera" para iniciar o sistema</li>
          <li>Digite seu nome completo no campo abaixo</li>
          <li>Clique em "Capturar Rosto (20x)" para registrar seu rosto</li>
          <li>Mantenha-se na frente da c√¢mera e espere o processo completar</li>
          <li>Aguarde at√© o status confirmar o cadastro</li>
          <li>Veja seu nome na lista de usu√°rios cadastrados</li>
          <li>Selecione um nome e clique em "Excluir" para remover cadastro</li>
          <li>O sistema reconhecer√° voc√™ automaticamente ap√≥s cadastro</li>
        </ol>
        <div class="facial-science">
          <h3>üß† Como Funciona:</h3>
          <p>O sistema utiliza uma rede neural para analisar 468 pontos faciais e criar uma "impress√£o digital" √∫nica do seu rosto, armazenando apenas dados matem√°ticos, n√£o imagens.</p>
        </div>
      </div>
      <div class="panel">
        <div class="video-container">
          <video id="videoFeed" autoplay playsinline></video>
          <div class="canvas-container">
            <canvas id="faceCanvas"></canvas>
          </div>
        </div>
        <div class="controls">
          <button id="btnStart">üé• Ligar C√¢mera</button>
          <button id="btnCapture" disabled>üì∏ Capturar Rosto (20x)</button>
          <button id="btnStop" disabled>‚èπÔ∏è Desligar C√¢mera</button>
        </div>
        <input type="text" id="userName" placeholder="Digite seu nome completo"/>
        
        <div class="progress-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div id="status">üî¥ Status: Aguardando inicializa√ß√£o</div>
        <div id="results">üë§ Nenhuma pessoa reconhecida</div>
        
        <div class="manage">
          <select id="userList" multiple></select>
          <button id="btnDelete">üóëÔ∏è Excluir Cadastro</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
  
  <script>
    // Elementos DOM
    const video = document.getElementById('videoFeed');
    const canvas = document.getElementById('faceCanvas');
    const ctx = canvas.getContext('2d');
    const btnStart = document.getElementById('btnStart');
    const btnCapture = document.getElementById('btnCapture');
    const btnStop = document.getElementById('btnStop');
    const userName = document.getElementById('userName');
    const status = document.getElementById('status');
    const results = document.getElementById('results');
    const userList = document.getElementById('userList');
    const btnDelete = document.getElementById('btnDelete');
    const progressBar = document.getElementById('progressBar');

    // Vari√°veis de estado
    let cameraStream;
    let isCapturing = false, captureCount = 0;
    const TOTAL_CAPTURES = 20, CAPTURE_DELAY = 250;
    let lastCapture = 0;
    let faceMesh;
    let faceDB = { users: [] };
    let currentEmbedding = null;
    let lastFaceDetection = 0;
    const DETECTION_INTERVAL = 300; // ms entre detec√ß√µes

    // Carregar banco de dados de faces
<<<<<<< HEAD
    function loadFaceDB() {
      const savedDB = localStorage.getItem('faceDB');
      if (savedDB) {
        try {
          faceDB = JSON.parse(savedDB);
        } catch (e) {
          console.error("Erro ao carregar banco de dados:", e);
          faceDB = { users: [] };
        }
      }
      updateUserList();
=======
    let faceDB = JSON.parse(localStorage.getItem('faceDB') || '{"users":[]}');
    if (typeof faceDB === 'string') {
      faceDB = JSON.parse(faceDB);
>>>>>>> 5cff0f7cc0adcd139fb07a1200f8a500afb45110
    }

    // Fun√ß√£o para calcular similaridade de cosseno
    function cosineSimilarity(a, b) {
      if (!a || !b || a.length !== b.length) return 0;
      
      let dot = 0, magA = 0, magB = 0;
      for (let i = 0; i < a.length; i++) {
        dot += a[i] * b[i];
        magA += a[i] * a[i];
        magB += b[i] * b[i];
      }
      magA = Math.sqrt(magA);
      magB = Math.sqrt(magB);
      return magA && magB ? dot / (magA * magB) : 0;
    }

    // Fun√ß√£o para reconhecer um rosto com base em embeddings
    function recognizeFace(embedding) {
      if (!embedding || !faceDB.users.length) {
        results.textContent = 'üë§ Nenhuma pessoa reconhecida';
        results.style.color = '#ff9800';
        return;
      }
      
      let bestMatch = { name: 'Desconhecido', similarity: 0 };
      
      faceDB.users.forEach(user => {
        user.embeddings.forEach(userEmb => {
          const similarity = cosineSimilarity(embedding, userEmb);
          if (similarity > bestMatch.similarity) {
            bestMatch = { name: user.name, similarity };
          }
        });
      });

      // Limiar de confian√ßa ajustado
      const confidenceThreshold = 0.75;
      
      if (bestMatch.similarity > confidenceThreshold) {
        const confidencePercent = Math.round(bestMatch.similarity * 100);
        results.textContent = `üëã Bem-vindo, ${bestMatch.name}! (${confidencePercent}% de confian√ßa)`;
        results.style.color = '#4caf50';
      } else {
        results.textContent = 'ü§∑‚Äç‚ôÇÔ∏è Pessoa n√£o reconhecida';
        results.style.color = '#f44336';
      }
    }

    // Salvar embedding facial no banco de dados
    function saveEmbedding(emb) {
      const name = userName.value.trim();
      if (!name) return;

      let user = faceDB.users.find(u => u.name === name);
      if (!user) {
        user = { name, embeddings: [] };
        faceDB.users.push(user);
      }
      
      user.embeddings.push(emb);
      localStorage.setItem('faceDB', JSON.stringify(faceDB));
    }

    // Inicializar o modelo de detec√ß√£o facial
    async function initFaceMesh() {
      try {
        faceMesh = new FaceMesh({
          locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
          }
        });
        
        faceMesh.setOptions({
          maxNumFaces: 1,
          refineLandmarks: true,
          minDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5
        });
        
        faceMesh.onResults(onFaceResults);
        
        status.textContent = 'üü¢ Sistema pronto para detec√ß√£o facial';
        status.className = 'ready';
        return true;
      } catch (error) {
        status.textContent = 'üî¥ Erro ao inicializar IA: ' + error.message;
        status.className = 'warning';
        console.error('Erro na inicializa√ß√£o:', error);
        return false;
      }
    }

    // Processar resultados da detec√ß√£o facial
    function onFaceResults(results) {
      if (!video.videoWidth || !video.videoHeight) return;
      
      // Ajustar tamanho do canvas
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      // Limpar canvas
      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      if (results.multiFaceLandmarks) {
        // Desenhar pontos faciais
        for (const landmarks of results.multiFaceLandmarks) {
          drawLandmarks(ctx, landmarks);
        }
        
        // Processar apenas uma face
        if (results.multiFaceLandmarks.length > 0) {
          const now = Date.now();
          
          // Limitar frequ√™ncia de detec√ß√£o
          if (now - lastFaceDetection > DETECTION_INTERVAL) {
            lastFaceDetection = now;
            
            // Criar embedding simplificado
            const embedding = createFaceEmbedding(results.multiFaceLandmarks[0]);
            currentEmbedding = embedding;
            
            // Modo de captura
            if (isCapturing) {
              if (now - lastCapture > CAPTURE_DELAY) {
                lastCapture = now;
                captureCount++;
                
                // Atualizar barra de progresso
                const progressPercent = (captureCount / TOTAL_CAPTURES) * 100;
                progressBar.style.width = `${progressPercent}%`;
                
                status.textContent = `üì∏ Capturando ${captureCount}/${TOTAL_CAPTURES}`;
                status.className = 'capturing';
                
                saveEmbedding(embedding);
                
                if (captureCount >= TOTAL_CAPTURES) {
                  stopCapture();
                }
              }
            } 
            // Modo de reconhecimento
            else {
              recognizeFace(embedding);
            }
          }
        }
      } else {
        results.textContent = 'üëÄ Nenhum rosto detectado';
        results.style.color = '#ff9800';
      }
      
      ctx.restore();
    }

    // Criar embedding facial a partir dos landmarks
    function createFaceEmbedding(landmarks) {
      // Selecionar pontos-chave para o embedding (olhos, nariz, boca, contorno)
      const keyPoints = [
        landmarks[10],  // Testa
        landmarks[152], // Queixo
        landmarks[33],  // Nariz
        landmarks[263], // Olho esquerdo
        landmarks[33],  // Olho direito
        landmarks[61],  // Boca esquerda
        landmarks[291], // Boca direita
        landmarks[199]  // Centro do rosto
      ];
      
      // Criar vetor de embedding
      const embedding = [];
      for (const point of keyPoints) {
        embedding.push(point.x);
        embedding.push(point.y);
        embedding.push(point.z);
      }
      
      return embedding;
    }

    // Desenhar pontos faciais
    function drawLandmarks(ctx, landmarks) {
      ctx.fillStyle = '#00FF00';
      
      // Desenhar pontos faciais
      for (const point of landmarks) {
        ctx.beginPath();
        ctx.arc(point.x * canvas.width, point.y * canvas.height, 2, 0, 2 * Math.PI);
        ctx.fill();
      }
      
      // Desenhar contorno do rosto
      ctx.strokeStyle = '#00FF00';
      ctx.lineWidth = 1;
      ctx.beginPath();
      
      // Pontos de contorno (ajustados para Face Mesh)
      const contourPoints = [10, 338, 297, 332, 284, 251, 389, 356, 454, 323, 361, 288, 
                            397, 365, 379, 378, 400, 377, 152, 148, 176, 149, 150, 136, 
                            172, 58, 132, 93, 234, 127, 162, 21, 54, 103, 67, 109];
      
      for (let i = 0; i < contourPoints.length; i++) {
        const point = landmarks[contourPoints[i]];
        if (i === 0) {
          ctx.moveTo(point.x * canvas.width, point.y * canvas.height);
        } else {
          ctx.lineTo(point.x * canvas.width, point.y * canvas.height);
        }
      }
      
      ctx.closePath();
      ctx.stroke();
    }

    // Iniciar captura de rostos
    function startCapture() {
      const name = userName.value.trim();
      if (!name) {
        alert('Por favor, digite seu nome completo antes de capturar.');
        return;
      }
      
      isCapturing = true;
      captureCount = 0;
      lastCapture = 0;
      progressBar.style.width = '0%';
      btnCapture.disabled = true;
      userName.disabled = true;
      
      status.textContent = '‚è≥ Preparando captura...';
      status.className = 'capturing';
    }

    // Parar captura de rostos
    function stopCapture() {
      isCapturing = false;
      btnCapture.disabled = false;
      userName.disabled = false;
      
      const name = userName.value.trim();
      status.textContent = `‚úÖ ${name} cadastrado com sucesso!`;
      status.className = 'ready';
      userName.value = '';
      
      updateUserList();
    }

    // Atualizar lista de usu√°rios
    function updateUserList() {
      userList.innerHTML = '';
      faceDB.users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.name;
        option.textContent = `${user.name} (${user.embeddings.length} embeddings)`;
        userList.appendChild(option);
      });
    }

    // Iniciar detec√ß√£o facial
    async function startFaceDetection() {
      if (!video.videoWidth || !video.videoHeight) {
        requestAnimationFrame(startFaceDetection);
        return;
      }
      
      try {
        await faceMesh.send({image: video});
        requestAnimationFrame(startFaceDetection);
      } catch (error) {
        console.error("Erro na detec√ß√£o facial:", error);
        setTimeout(() => startFaceDetection(), 100);
      }
    }

    // Event Listeners
    btnStart.addEventListener('click', async () => {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'user',
            width: { ideal: 640 },
            height: { ideal: 480 }
          } 
        });
        video.srcObject = cameraStream;
        
        // Aguardar o v√≠deo carregar
        video.onloadedmetadata = async () => {
          const initialized = await initFaceMesh();
          if (initialized) {
            startFaceDetection();
          }
        };
        
        btnStart.disabled = true;
        btnStop.disabled = false;
        btnCapture.disabled = false;
        
        status.textContent = 'üü¢ C√¢mera ativa - Sistema operacional';
        status.className = 'ready';
      } catch (error) {
        status.textContent = 'üî¥ Erro ao acessar a c√¢mera: ' + error.message;
        status.className = 'warning';
        console.error('Erro na c√¢mera:', error);
      }
    });

    btnCapture.addEventListener('click', startCapture);

    btnStop.addEventListener('click', () => {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      
      btnStart.disabled = false;
      btnStop.disabled = true;
      btnCapture.disabled = true;
      
      status.textContent = '‚èπÔ∏è C√¢mera desligada';
      results.textContent = 'üë§ Sistema inativo';
      results.style.color = '#9e9e9e';
    });

    btnDelete.addEventListener('click', () => {
      const selectedUser = userList.value;
      if (!selectedUser) {
        alert('Por favor, selecione um usu√°rio para excluir.');
        return;
      }
      
      faceDB.users = faceDB.users.filter(user => user.name !== selectedUser);
      localStorage.setItem('faceDB', JSON.stringify(faceDB));
      
      updateUserList();
      status.textContent = `üóëÔ∏è ${selectedUser} foi removido do sistema`;
    });

    // Inicializar
    loadFaceDB();
  </script>
</body>
</html>