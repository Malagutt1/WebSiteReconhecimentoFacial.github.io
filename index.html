<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Sistema de Reconhecimento Facial Avan√ßado</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
    }
    
    h1 {
      text-align: center;
      padding: 25px;
      background: rgba(0, 0, 0, 0.4);
      font-size: 2.2rem;
      letter-spacing: 1px;
      border-bottom: 2px solid #00b4d8;
    }
    
    .split {
      display: flex;
      flex-wrap: wrap;
      padding: 20px;
      gap: 25px;
    }
    
    .panel {
      flex: 1;
      min-width: 300px;
      background: rgba(30, 30, 50, 0.8);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
    }
    
    .panel h2 {
      color: #00b4d8;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #00b4d8;
      font-size: 1.8rem;
    }
    
    ol {
      padding-left: 25px;
      margin-bottom: 25px;
    }
    
    ol li {
      margin-bottom: 12px;
      line-height: 1.6;
    }
    
    .facial-science {
      background: rgba(0, 180, 216, 0.15);
      padding: 18px;
      border-radius: 12px;
      margin-top: auto;
    }
    
    .facial-science h3 {
      color: #90e0ef;
      margin-bottom: 12px;
    }
    
    .facial-science p {
      line-height: 1.7;
    }
    
    .video-container {
      position: relative;
      width: 100%;
      padding-top: 75%;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
      transform: scaleX(-1); /* Corrige o espelhamento */
    }
    
    #videoFeed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .canvas-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
    }
    
    #faceCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    button {
      flex: 1;
      min-width: 120px;
      padding: 14px;
      background: linear-gradient(to right, #0077b6, #00b4d8);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button:hover {
      background: linear-gradient(to right, #0067a6, #0096c7);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 180, 216, 0.4);
    }
    
    button:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.7;
    }
    
    #userName {
      width: 100%;
      padding: 14px;
      margin-bottom: 20px;
      border-radius: 8px;
      border: 2px solid #00b4d8;
      background: rgba(0, 0, 0, 0.4);
      color: white;
      font-size: 1rem;
    }
    
    #userName:focus {
      outline: none;
      border-color: #90e0ef;
      box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.3);
    }
    
    .progress-container {
      width: 100%;
      height: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, #4caf50, #8bc34a);
      border-radius: 10px;
      transition: width 0.3s ease;
    }
    
    #status {
      padding: 14px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
      text-align: center;
      background: rgba(0, 0, 0, 0.4);
      transition: all 0.3s ease;
    }
    
    .ready {
      background: rgba(76, 175, 80, 0.2);
      color: #a5d6a7;
    }
    
    .capturing {
      background: rgba(255, 193, 7, 0.2);
      color: #ffd54f;
    }
    
    .warning {
      background: rgba(244, 67, 54, 0.2);
      color: #ef9a9a;
    }
    
    #results {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.2rem;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.4);
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .manage {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: auto;
    }
    
    #userList {
      width: 100%;
      height: 150px;
      padding: 12px;
      border-radius: 8px;
      border: 2px solid #00b4d8;
      background: rgba(0, 0, 0, 0.4);
      color: white;
      font-size: 1rem;
    }
    
    #userList option {
      padding: 8px;
      border-bottom: 1px solid #444;
    }
    
    @media (max-width: 768px) {
      .split {
        flex-direction: column;
      }
      
      h1 {
        font-size: 1.8rem;
        padding: 15px;
      }
      
      .panel {
        padding: 20px;
      }
      
      .controls {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ Sistema de Reconhecimento Facial Avan√ßado ü§ñ</h1>
    <div class="split">
      <div class="panel">
        <h2>üìã INSTRU√á√ïES</h2>
        <ol>
          <li>Clique em "Ligar C√¢mera" para iniciar o sistema</li>
          <li>Digite seu nome completo no campo abaixo</li>
          <li>Clique em "Capturar Rosto (20x)" para registrar seu rosto</li>
          <li>Mantenha-se na frente da c√¢mera e espere o processo completar</li>
          <li>Aguarde at√© o status confirmar o cadastro</li>
          <li>Veja seu nome na lista de usu√°rios cadastrados</li>
          <li>Selecione um nome e clique em "Excluir" para remover cadastro</li>
          <li>O sistema reconhecer√° voc√™ automaticamente ap√≥s cadastro</li>
        </ol>
        <div class="facial-science">
          <h3>üß† Como Funciona:</h3>
          <p>O sistema utiliza uma rede neural para analisar 468 pontos faciais e criar uma "impress√£o digital" √∫nica do seu rosto, armazenando apenas dados matem√°ticos, n√£o imagens.</p>
        </div>
      </div>
      <div class="panel">
        <div class="video-container">
          <video id="videoFeed" autoplay playsinline></video>
          <div class="canvas-container">
            <canvas id="faceCanvas"></canvas>
          </div>
        </div>
        <div class="controls">
          <button id="btnStart">üé• Ligar C√¢mera</button>
          <button id="btnCapture" disabled>üì∏ Capturar Rosto (20x)</button>
          <button id="btnStop" disabled>‚èπÔ∏è Desligar C√¢mera</button>
        </div>
        <input type="text" id="userName" placeholder="Digite seu nome completo"/>
        
        <div class="progress-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div id="status">üî¥ Status: Aguardando inicializa√ß√£o</div>
        <div id="results">üë§ Nenhuma pessoa reconhecida</div>
        
        <div class="manage">
          <select id="userList" multiple></select>
          <button id="btnDelete">üóëÔ∏è Excluir Cadastro</button>
        </div>
      </div>
    </div>
  </div>

    <!-- Scripts Mediapipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
  
    <script>
      // Fun√ß√£o para criar um embedding simplificado a partir dos pontos faciais
      function createFaceEmbedding(landmarks) {
        const flat = landmarks.flatMap(p => [p.x, p.y, p.z]);
        const mean = flat.reduce((sum, val) => sum + val, 0) / flat.length;
        const normalized = flat.map(v => v - mean);
        return normalized;
      }
  
      function drawLandmarks(ctx, landmarks) {
        ctx.fillStyle = '#00b4d8';
        landmarks.forEach(p => {
          const x = p.x * canvas.width;
          const y = p.y * canvas.height;
          ctx.beginPath();
          ctx.arc(x, y, 1.5, 0, 2 * Math.PI);
          ctx.fill();
        });
      }
  
      // Atualizar a lista de usu√°rios no <select>
      function updateUserList() {
        userList.innerHTML = '';
        faceDB.users.forEach(user => {
          const opt = document.createElement('option');
          opt.value = user.name;
          opt.textContent = user.name;
          userList.appendChild(opt);
        });
      }
  
      // Inicializar c√¢mera
      async function startCamera() {
        try {
          cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
          video.srcObject = cameraStream;
          btnStop.disabled = false;
          btnCapture.disabled = false;
          btnStart.disabled = true;
          status.textContent = 'üü¢ C√¢mera ligada';
          status.className = 'ready';
          loadFaceDB();
  
          // Inicializar FaceMesh
          await initFaceMesh();
  
          const camera = new Camera(video, {
            onFrame: async () => {
              await faceMesh.send({ image: video });
            },
            width: 640,
            height: 480
          });
  
          camera.start();
        } catch (err) {
          console.error('Erro ao acessar c√¢mera:', err);
          status.textContent = 'üî¥ Erro ao acessar c√¢mera';
          status.className = 'warning';
        }
      }
  
      // Parar c√¢mera
      function stopCamera() {
        if (cameraStream) {
          const tracks = cameraStream.getTracks();
          tracks.forEach(track => track.stop());
          video.srcObject = null;
        }
        btnStart.disabled = false;
        btnStop.disabled = true;
        btnCapture.disabled = true;
        status.textContent = 'üî¥ C√¢mera desligada';
        status.className = 'warning';
      }
  
      // Captura de rosto em sequ√™ncia
      async function startCapture() {
        if (!userName.value.trim()) {
          alert('Digite seu nome antes de capturar.');
          return;
        }
  
        isCapturing = true;
        captureCount = 0;
        status.textContent = 'üü° Capturando rosto...';
        status.className = 'capturing';
  
        const interval = setInterval(() => {
          if (!currentEmbedding || !isCapturing) return;
  
          saveEmbedding(currentEmbedding);
          captureCount++;
  
          const percent = (captureCount / TOTAL_CAPTURES) * 100;
          progressBar.style.width = percent + '%';
  
          if (captureCount >= TOTAL_CAPTURES) {
            clearInterval(interval);
            isCapturing = false;
            progressBar.style.width = '100%';
            status.textContent = '‚úÖ Rosto cadastrado com sucesso!';
            status.className = 'ready';
            updateUserList();
          }
        }, CAPTURE_DELAY);
      }
  
      // Deletar usu√°rio
      function deleteUser() {
        const selected = Array.from(userList.selectedOptions).map(opt => opt.value);
        faceDB.users = faceDB.users.filter(u => !selected.includes(u.name));
        localStorage.setItem('faceDB', JSON.stringify(faceDB));
        updateUserList();
        results.textContent = 'üë§ Cadastro(s) exclu√≠do(s)';
        results.style.color = '#ef9a9a';
      }
  
      // Eventos
      btnStart.addEventListener('click', startCamera);
      btnStop.addEventListener('click', stopCamera);
      btnCapture.addEventListener('click', startCapture);
      btnDelete.addEventListener('click', deleteUser);
  
      // Quando um embedding novo estiver dispon√≠vel
      function onFaceResults(results) {
        if (!video.videoWidth || !video.videoHeight) return;
  
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  
        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
          const now = Date.now();
          if (now - lastFaceDetection > DETECTION_INTERVAL) {
            lastFaceDetection = now;
            currentEmbedding = createFaceEmbedding(results.multiFaceLandmarks[0]);
            if (!isCapturing) recognizeFace(currentEmbedding);
          }
          for (const landmarks of results.multiFaceLandmarks) {
            drawLandmarks(ctx, landmarks);
          }
        }
        ctx.restore();
      }
  
      // Inicializar banco de dados ao carregar
      window.addEventListener('DOMContentLoaded', loadFaceDB);
    </script>
  </body>
  </html>