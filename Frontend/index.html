<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <link rel="stylesheet" href="styles.css">
  <title>Sistema de Reconhecimento Facial</title>
</head>
<body>
  <div class="container">
    <h1>🤖 Sistema de Reconhecimento Facial 🤖</h1>
    <div class="split">
      <div class="panel">
        <h2>📋 INSTRUÇÕES</h2>
        <ol>
          <li>Clique em “Ligar Câmera”</li>
          <li>Digite seu nome completo</li>
          <li>Clique em “Capturar Rosto (20x)”</li>
          <li>Aguarde até o status confirmar</li>
          <li>Veja seu nome na lista</li>
          <li>Selecione e clique em “Excluir” para remover</li>
        </ol>
      </div>
      <div class="panel">
        <div class="video-container"><video id="videoFeed" autoplay playsinline></video></div>
        <div class="controls">
          <button id="btnStart">🎥 Ligar Câmera</button>
          <button id="btnCapture" disabled>📸 Capturar Rosto (20x)</button>
          <button id="btnStop" disabled>⏹️ Desligar Câmera</button>
        </div>
        <input type="text" id="userName" placeholder="Digite seu nome completo"/>
        <div id="status">🔴 Status: Aguardando inicialização</div>
        <div id="results"></div>
        <div class="manage">
          <select id="userList" multiple></select>
          <button id="btnDelete">🗑️ Excluir Cadastro</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as vision from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.mjs';

    const video = document.getElementById('videoFeed');
    const btnStart = document.getElementById('btnStart');
    const btnCapture = document.getElementById('btnCapture');
    const btnStop = document.getElementById('btnStop');
    const userName = document.getElementById('userName');
    const status = document.getElementById('status');
    const results = document.getElementById('results');
    const userList = document.getElementById('userList');
    const btnDelete = document.getElementById('btnDelete');

    let faceDetector, cameraStream;
    let isCapturing = false, captureCount = 0;
    const TOTAL = 20, DELAY = 250;
    let lastCapture = 0;
    let loopInterval;

    // Função para recuperar usuários do localStorage
    function loadUsers() {
      const users = JSON.parse(localStorage.getItem('users')) || [];
      return users;
    }

    // Função para salvar usuários no localStorage
    function saveUsers(users) {
      localStorage.setItem('users', JSON.stringify(users));
    }

    // Função para salvar os embeddings no localStorage
    function saveEmbedding(emb) {
      const name = userName.value.trim();
      if (!name) return alert('Digite um nome!');

      // Recupera os usuários já cadastrados
      let users = loadUsers();

      // Verifica se o nome já existe
      const existingUser = users.find(user => user.name === name);
      if (existingUser) {
        existingUser.embeddings.push(emb);
      } else {
        users.push({ name, embeddings: [emb] });
      }

      // Salva os dados atualizados no localStorage
      saveUsers(users);
      status.textContent = `✅ ${name} cadastrado!`;
      updateList();
    }

    // Função para atualizar a lista de usuários no frontend
    function updateList() {
      const users = loadUsers();
      userList.innerHTML = '';
      users.forEach((user) => {
        const option = document.createElement('option');
        option.value = user.name;
        option.textContent = `${user.name} (${user.embeddings.length} fotos)`;
        userList.append(option);
      });
    }

    // Função para excluir um usuário
    function deleteUser() {
      const selectedName = userList.value;
      if (!selectedName) return;

      // Recupera os usuários
      let users = loadUsers();

      // Filtra o usuário selecionado
      users = users.filter(user => user.name !== selectedName);

      // Salva novamente no localStorage
      saveUsers(users);
      updateList();
      status.textContent = `🗑️ ${selectedName} removido`;
    }

    // Função para iniciar a captura de vídeo
    btnStart.onclick = async () => {
      cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      video.srcObject = cameraStream;
      await init();
      loopInterval = setInterval(frameLoop, 100);
      btnStart.disabled = true;
      btnStop.disabled = false;
      btnCapture.disabled = false;
      status.textContent = '🟢 Câmera ativa';
    };

    // Função para parar a captura de vídeo
    btnStop.onclick = () => {
      cameraStream.getTracks().forEach((t) => t.stop());
      video.srcObject = null;
      clearInterval(loopInterval);
      btnStart.disabled = false;
      btnStop.disabled = true;
      btnCapture.disabled = true;
      status.textContent = '⏹️ Câmera parada';
      results.textContent = '';
    };

    // Função para capturar o rosto
    btnCapture.onclick = async () => {
      isCapturing = true;
      captureCount = 0;
      lastCapture = 0;
      btnCapture.disabled = true;
      status.textContent = '⏳ Preparando captura...';
      setTimeout(() => (status.textContent = '📸 Capturando fotos...'), 500);
    };

    // Função de detecção e captura de rostos
    async function frameLoop() {
      if (!faceDetector || !cameraStream) return;
      const now = performance.now();
      const res = await faceDetector.detectForVideo(video, now);
      if (res.detections.length) {
        const emb = res.detections[0].keypoints.flatMap((p) => [p.x, p.y]);
        if (isCapturing && now - lastCapture > DELAY) {
          lastCapture = now;
          captureCount++;
          status.textContent = `📸 Capturando ${captureCount}/${TOTAL}`;
          saveEmbedding(emb);
          if (captureCount >= TOTAL) stopCapture();
        }
      }
    }

    // Função para parar a captura
    function stopCapture() {
      isCapturing = false;
      btnCapture.disabled = false;
      status.textContent = `✅ ${userName.value.trim()} cadastrado!`;
      userName.value = '';
      updateList();
    }

    // Inicializa a detecção de rostos
    async function init() {
      try {
        const fileset = await vision.FilesetResolver.forVisionTasks(
          'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm'
        );
        faceDetector = await vision.FaceDetector.createFromOptions(fileset, {
          baseOptions: {
            modelAssetPath:
              'https://storage.googleapis.com/mediapipe-models/face_detector/blaze_face_short_range/float16/latest/blaze_face_short_range.tflite',
            delegate: 'GPU',
          },
          runningMode: 'VIDEO',
          minDetectionConfidence: 0.85,
        });
        status.textContent = '🟢 Sistema pronto';
      } catch (e) {
        status.textContent = '🔴 Erro IA: ' + e.message;
      }
    }

    // Função para excluir um usuário
    btnDelete.onclick = deleteUser;

    // Carregar a lista de usuários quando a página carregar
    updateList();
  </script>
</body>
</html>
